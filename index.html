<!DOCTYPE html>
<html lang="ja" class="antialiased">
<head>
    <meta charset="UTF-8">
    <title>Stock Rescue | å…¥è·å“å»ƒæ£„ã‚¼ãƒ­åŒ–ã‚·ã‚¹ãƒ†ãƒ  (Portfolio Demo)</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Noto Sans JP', 'sans-serif'] },
                    colors: { 
                        corporate: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#0ea5e9', 700:'#0369a1', 800:'#075985', 900:'#0c4a6e' },
                        gray: { 50:'#f9fafb', 100:'#f3f4f6', 200:'#e5e7eb', 300:'#d1d5db', 400:'#9ca3af', 500:'#6b7280', 600:'#4b5563', 700:'#374151', 800:'#1f2937', 900:'#111827' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f9fafb; color: #1f2937; }
        .dark body { background-color: #111827; color: #f3f4f6; }
        
        .card { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .dark .card { background-color: #1f2937; border-color: #374151; box-shadow: none; }
        
        .input-box { background-color: #ffffff; border: 1px solid #d1d5db; color: #1f2937; border-radius: 0.5rem; padding: 0.6rem 0.8rem; outline: none; width: 100%; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
        .input-box:focus { border-color: #0ea5e9; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }
        .dark .input-box { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        .dark .input-box:focus { border-color: #38bdf8; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }

        .nav-link.active { background-color: #e0f2fe; color: #0369a1; font-weight: 700; border-right: 3px solid #0369a1; }
        .dark .nav-link.active { background-color: #1e293b; color: #38bdf8; border-right-color: #38bdf8; }
        .mobile-tab.active { color: #0369a1; } .dark .mobile-tab.active { color: #38bdf8; }

        .slide-panel { position: fixed; right: 0; top: 0; width: 100%; max-width: 450px; height: 100vh; background: white; z-index: 2001; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; border-left: 1px solid #e5e7eb; }
        .dark .slide-panel { background: #1f2937; border-left-color: #374151; }
        .slide-panel.open { transform: translateX(0); }
        
        /* ëª¨ë°”ì¼ì—ì„œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ ê½‰ ì°¨ê²Œ */
        @media (max-width: 768px) { .slide-panel { max-width: 100%; border-left: none; } }

        .overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.6); z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .overlay.open { opacity: 1; pointer-events: auto; }

        #intro-screen { position: fixed; inset: 0; background-color: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s, visibility 0.8s; }
        .dark #intro-screen { background-color: #111827; }
        #intro-screen.fade-out { opacity: 0; visibility: hidden; pointer-events: none; }
        
        #galleryOverlay { background-color: rgba(17, 24, 39, 0.95); backdrop-filter: blur(8px); }
        #galleryContainer { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <div id="intro-screen">
        <canvas id="intro-canvas" class="absolute inset-0 w-full h-full opacity-60"></canvas>
        <div class="relative z-10 text-center animate-fade-in">
            <h1 class="text-2xl font-black tracking-tight text-gray-900 dark:text-white mb-2">Stock Rescue</h1>
            <p class="text-xs font-bold text-corporate-600 dark:text-corporate-400 font-mono">Portfolio Demo Version</p>
            <div class="inline-block w-8 h-8 mt-6 border-2 border-gray-200 border-t-corporate-600 rounded-full animate-spin"></div>
        </div>
    </div>

    <div id="loadingSpinner" class="fixed inset-0 bg-gray-900/40 z-[9998] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-xl flex flex-col items-center gap-3">
            <i class="ph-bold ph-circle-notch animate-spin text-3xl text-corporate-600"></i>
            <span class="text-xs font-bold text-gray-500">Processing...</span>
        </div>
    </div>

    <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 hidden md:flex flex-col z-20">
        <div class="h-16 flex items-center px-6 border-b border-gray-200 dark:border-gray-700 shrink-0">
            <div class="w-8 h-8 bg-corporate-700 rounded-md flex items-center justify-center text-white mr-3 shadow-inner">
                <i class="ph-bold ph-cube text-xl"></i>
            </div>
            <h1 class="text-lg font-bold text-gray-800 dark:text-white tracking-tight">Stock Rescue</h1>
        </div>
        
        <div class="px-6 py-6 flex-1 overflow-y-auto">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-3">Menu</p>
            <nav class="space-y-1.5">
                <button onclick="AppRouter.switch('dashboard')" id="nav-dash" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <i class="ph-fill ph-chart-line-up text-lg"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </button>
                <button onclick="AppRouter.switch('input')" id="nav-input" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <i class="ph-fill ph-database text-lg"></i> ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                </button>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-200 dark:border-gray-700 shrink-0">
            <button onclick="window.ThemeManager.toggle()" class="flex items-center justify-between w-full px-3 py-2 text-sm text-gray-500 hover:text-gray-800 dark:hover:text-white transition-colors bg-gray-50 dark:bg-gray-900 rounded-md border border-gray-200 dark:border-gray-700">
                <span class="font-medium">Dark Mode</span>
                <i class="ph-bold ph-moon-stars text-lg" id="themeIcon"></i>
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen relative bg-gray-50 dark:bg-gray-900">
        
        <header class="md:hidden h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 z-20 shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-7 h-7 bg-corporate-700 rounded-md flex items-center justify-center text-white"><i class="ph-bold ph-cube text-base"></i></div>
                <h1 class="text-base font-bold text-gray-800 dark:text-white">Stock Rescue</h1>
            </div>
            <button onclick="window.ThemeManager.toggle()" class="text-gray-500 p-2"><i class="ph-bold ph-moon-stars text-xl" id="themeIconMobile"></i></button>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto pb-20 md:pb-8 relative">
            
            <div id="view-dashboard" class="hidden p-4 md:p-8 max-w-[1400px] mx-auto w-full animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                        <p class="text-sm text-gray-500 mt-1">åœ¨åº«çŠ¶æ³ãŠã‚ˆã³çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="monthFilter" class="input-box w-auto py-1.5 h-9" onchange="DashboardApp.fetchData()"></select>
                        <button onclick="DashboardApp.fetchData()" class="h-9 px-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 shadow-sm"><i class="ph-bold ph-arrows-clockwise"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-start">
                    <div class="flex flex-col gap-6 md:col-span-4 lg:col-span-3">
                        <div id="kpiGrid" class="grid grid-cols-2 gap-3"></div>
                        
                        <div class="card p-5 border-l-4 border-l-red-500" id="warningContainer" style="display: none;">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-bold text-red-600 dark:text-red-400 flex items-center gap-2"><i class="ph-fill ph-warning-circle"></i> åœ¨åº«è¶…éè­¦å‘Š</h3>
                                <input type="number" id="warningThreshold" value="20" class="w-12 text-center text-xs font-bold bg-red-50 dark:bg-red-900/30 text-red-600 rounded border-none outline-none py-1" onchange="DashboardApp.renderWarning()">
                            </div>
                            <div class="max-h-[150px] overflow-y-auto no-scrollbar">
                                <table class="w-full text-left text-sm"><tbody id="warningTableBody" class="divide-y divide-gray-100 dark:divide-gray-700/50"></tbody></table>
                            </div>
                        </div>

                        <div class="card p-5 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-800/50">
                            <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-3 flex items-center gap-2"><i class="ph-duotone ph-clipboard-text text-corporate-500"></i> ã‚µãƒãƒªãƒ¼</h3>
                            <ul id="summaryList" class="space-y-2 text-sm text-gray-600 dark:text-gray-400"></ul>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6 md:col-span-8 lg:col-span-5">
                        <div class="card p-5 flex flex-col h-64">
                            <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2" id="comparisonChartTitle">æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
                            <div class="flex-1 w-full relative"><canvas id="comparisonChart"></canvas></div>
                        </div>
                        <div class="card p-5 flex flex-col h-64">
                            <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2" id="deptChartTitle">éƒ¨ç½²åˆ¥ åœ¨åº«</h3>
                            <div class="flex-1 w-full relative"><canvas id="departmentChart"></canvas></div>
                        </div>
                    </div>

                    <div class="flex flex-col h-full md:col-span-12 lg:col-span-4">
                        <div class="card flex flex-col h-full">
                            <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50 rounded-t-xl">
                                <h3 class="text-sm font-bold text-gray-800 dark:text-white"><i class="ph-fill ph-map-pin text-corporate-500 mr-1"></i> ä¿ç®¡å ´æ‰€åˆ¥ è©³ç´°</h3>
                            </div>
                            <div id="dataCardsContainer" class="flex-1 p-4 grid gap-3 max-h-[500px] overflow-y-auto content-start"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-input" class="hidden p-4 md:p-8 max-w-5xl mx-auto w-full animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                        <p class="text-sm text-gray-500 mt-1">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®æ–°è¦ç™»éŒ²ãƒ»ç·¨é›†</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <div class="relative flex-1 md:w-64">
                            <i class="ph-regular ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="input-search" class="input-box pl-9" placeholder="åå‰ã€å ´æ‰€ã§æ¤œç´¢..." onkeyup="InputApp.filterList(this.value)">
                        </div>
                        <button onclick="InputApp.openPanel('create')" class="h-10 px-4 bg-corporate-700 hover:bg-corporate-800 text-white rounded-md text-sm font-bold transition-colors shadow-sm whitespace-nowrap flex items-center gap-2 active:scale-95">
                            <i class="ph-bold ph-plus"></i> <span class="hidden sm:inline">æ–°è¦ç™»éŒ²</span>
                        </button>
                    </div>
                </div>

                <div id="input-list-container" class="space-y-4"></div>
            </div>
            
        </main>
    </div>

    <nav class="md:hidden fixed bottom-0 left-0 w-full h-16 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex z-50 pb-safe">
        <button onclick="AppRouter.switch('dashboard')" id="mobile-nav-dash" class="mobile-tab flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 transition-colors">
            <i class="ph-fill ph-chart-line-up text-2xl"></i><span class="text-[10px] font-bold">ãƒ€ãƒƒã‚·ãƒ¥</span>
        </button>
        <button onclick="InputApp.openPanel('create')" class="flex-none w-16 flex items-center justify-center">
            <div class="w-12 h-12 bg-corporate-700 text-white rounded-full flex items-center justify-center shadow-lg transform -translate-y-2 active:scale-90 transition-transform">
                <i class="ph-bold ph-plus text-xl"></i>
            </div>
        </button>
        <button onclick="AppRouter.switch('input')" id="mobile-nav-input" class="mobile-tab flex-1 flex flex-col items-center justify-center gap-1 text-gray-400 transition-colors">
            <i class="ph-fill ph-database text-2xl"></i><span class="text-[10px] font-bold">ãƒ‡ãƒ¼ã‚¿</span>
        </button>
    </nav>

    <div id="form-overlay" class="overlay" onclick="InputApp.closePanel(); DashboardApp.closeLocationDetail();"></div>
    
    <aside id="form-panel" class="slide-panel">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shrink-0">
            <h3 id="panel-title" class="text-base font-bold text-gray-900 dark:text-white">è©³ç´°æƒ…å ±</h3>
            <div class="flex gap-2">
                <button id="btn-edit-mode" onclick="InputApp.enableEditMode()" class="hidden w-8 h-8 rounded-md bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300">
                    <i class="ph-bold ph-pencil-simple text-lg"></i>
                </button>
                <button onclick="InputApp.closePanel()" class="w-8 h-8 rounded-md bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6 py-5 bg-gray-50 dark:bg-gray-900">
            
            <div id="detail-view" class="space-y-6 animate-fade-in hidden">
                <div id="detail-photos" class="w-full"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <span class="block text-[10px] text-gray-400 font-bold uppercase mb-1">æ—¥ä»˜</span>
                        <span id="view-date" class="font-bold text-gray-800 dark:text-white text-sm"></span>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <span class="block text-[10px] text-gray-400 font-bold uppercase mb-1">æ•°é‡</span>
                        <div class="flex items-baseline gap-1">
                            <span id="view-qty" class="font-black text-corporate-600 dark:text-corporate-400 text-xl"></span>
                            <span class="text-[10px] text-gray-400 font-bold">å€‹</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <span class="block text-[10px] text-gray-400 font-bold uppercase mb-1">åå‰</span>
                        <p id="view-name" class="text-base font-bold text-gray-900 dark:text-white"></p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <span class="block text-[10px] text-gray-400 font-bold uppercase mb-1">éƒ¨ç½² / ç½®ãå ´</span>
                        <p id="view-location" class="text-sm font-medium text-gray-600 dark:text-gray-300"></p>
                    </div>
                </div>
            </div>

            <form id="dataForm" class="hidden flex flex-col pb-20">
                <input type="hidden" id="form-id">
                
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-500 mb-2">å†™çœŸ (æœ€å¤§3æš)</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="aspect-square rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 flex items-center justify-center cursor-pointer relative overflow-hidden group" onclick="InputApp.openSourceSelect('file1')">
                            <i class="ph-bold ph-camera text-2xl text-gray-400 group-hover:text-corporate-500 transition-colors"></i>
                            <img id="preview1" class="absolute inset-0 w-full h-full object-cover hidden">
                            <input type="file" id="file1" accept="image/*" class="hidden" onchange="InputApp.handleFileSelect(this, 'preview1')">
                            <button type="button" id="btn-draw-file1" onclick="InputApp.openDrawing('file1', event)" class="absolute bottom-1 right-1 w-8 h-8 bg-black/60 text-white rounded-full hidden items-center justify-center z-10"><i class="ph-bold ph-pencil-simple text-sm"></i></button>
                        </div>
                        <div class="aspect-square rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 flex items-center justify-center cursor-pointer relative overflow-hidden group" onclick="InputApp.openSourceSelect('file2')">
                            <i class="ph-bold ph-plus text-2xl text-gray-400 group-hover:text-corporate-500 transition-colors"></i>
                            <img id="preview2" class="absolute inset-0 w-full h-full object-cover hidden">
                            <input type="file" id="file2" accept="image/*" class="hidden" onchange="InputApp.handleFileSelect(this, 'preview2')">
                            <button type="button" id="btn-draw-file2" onclick="InputApp.openDrawing('file2', event)" class="absolute bottom-1 right-1 w-8 h-8 bg-black/60 text-white rounded-full hidden items-center justify-center z-10"><i class="ph-bold ph-pencil-simple text-sm"></i></button>
                        </div>
                        <div class="aspect-square rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 flex items-center justify-center cursor-pointer relative overflow-hidden group" onclick="InputApp.openSourceSelect('file3')">
                            <i class="ph-bold ph-plus text-2xl text-gray-400 group-hover:text-corporate-500 transition-colors"></i>
                            <img id="preview3" class="absolute inset-0 w-full h-full object-cover hidden">
                            <input type="file" id="file3" accept="image/*" class="hidden" onchange="InputApp.handleFileSelect(this, 'preview3')">
                            <button type="button" id="btn-draw-file3" onclick="InputApp.openDrawing('file3', event)" class="absolute bottom-1 right-1 w-8 h-8 bg-black/60 text-white rounded-full hidden items-center justify-center z-10"><i class="ph-bold ph-pencil-simple text-sm"></i></button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥ä»˜</label>
                        <input type="date" id="form-date" class="input-box">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ•°é‡</label>
                        <div class="relative">
                            <input type="number" id="form-qty" class="input-box pr-8 font-bold text-corporate-600" placeholder="0">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400">å€‹</span>
                        </div>
                    </div>
                </div>

                <div class="mb-4 relative">
                    <label class="block text-xs font-bold text-gray-500 mb-1">åå‰</label>
                    <input type="text" id="form-name" class="input-box font-bold" placeholder="ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›" autocomplete="off" onkeyup="InputApp.handleNameInput(this)">
                    <ul id="name-suggestions" class="hidden absolute left-0 top-[100%] mt-1 z-50 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto text-sm"></ul>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">éƒ¨ç½² / ç½®ãå ´</label>
                    <div class="flex flex-col gap-2">
                        <select id="form-dept" class="input-box">
                            <option value="">éƒ¨ç½²ã‚’é¸æŠ</option>
                            <option value="è£½é€ éƒ¨">è£½é€ éƒ¨</option><option value="ç·å‹™éƒ¨">ç·å‹™éƒ¨</option><option value="è³‡æèª²">è³‡æèª²</option><option value="å®‰å…¨ç®¡ç†">å®‰å…¨ç®¡ç†</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="text" id="form-location" class="input-box flex-1" placeholder="ç½®ãå ´ (ä¾‹: A-1)">
                            <button type="button" onclick="InputApp.startQRScanner()" class="w-10 bg-corporate-50 dark:bg-corporate-900/30 text-corporate-600 border border-corporate-200 dark:border-corporate-700 rounded-lg flex items-center justify-center hover:bg-corporate-100 transition-colors">
                                <i class="ph-bold ph-qr-code text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div id="form-footer" class="hidden absolute bottom-0 left-0 w-full p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shrink-0">
            <div class="flex items-center justify-between mb-3">
                <span id="session-counter-display" class="text-xs font-bold text-corporate-600 bg-corporate-50 dark:bg-corporate-900/30 px-2 py-1 rounded">ä»Šå›: 0ä»¶</span>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="continuous-mode" class="w-4 h-4 rounded border-gray-300 text-corporate-600 focus:ring-corporate-500">
                    <span class="text-xs font-bold text-gray-500">ç¶šã‘ã¦ç™»éŒ²</span>
                </label>
            </div>
            <button onclick="InputApp.submitData()" class="w-full py-3 bg-corporate-700 hover:bg-corporate-800 text-white font-bold rounded-lg shadow-md transition-colors active:scale-[0.98]">
                ä¿å­˜ã™ã‚‹
            </button>
        </div>
    </aside>

    <aside id="dashboard-panel" class="slide-panel">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <h3 id="dash-panel-title" class="text-base font-bold text-gray-900 dark:text-white">Location</h3>
            <button onclick="DashboardApp.closeLocationDetail()" class="w-8 h-8 rounded-md bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500"><i class="ph-bold ph-x"></i></button>
        </div>
        <div id="dash-panel-content" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50 dark:bg-gray-900"></div>
    </aside>

    <div id="galleryOverlay" class="fixed inset-0 z-[3000] hidden flex-col justify-center animate-fade-in" onclick="InputApp.closeGallery(event)">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-50 bg-gradient-to-b from-black/80 to-transparent">
            <div class="text-white font-bold truncate pr-4" id="galleryTitle">Photo</div>
            <button class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white backdrop-blur"><i class="ph-bold ph-x text-lg"></i></button>
        </div>
        <div id="galleryContainer" class="w-full h-full overflow-y-auto p-4 py-20 snap-y snap-mandatory flex flex-col items-center gap-4"></div>
    </div>

    <div id="sourceSelectOverlay" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[5000] hidden flex-col justify-end transition-opacity" onclick="InputApp.closeSourceSelect()">
        <div class="bg-white dark:bg-gray-800 w-full rounded-t-3xl p-6 pb-10 transform transition-transform translate-y-full" id="sourceSelectBox" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full mx-auto mb-6"></div>
            <h3 class="text-center text-lg font-bold text-gray-900 dark:text-white mb-6">å†™çœŸã‚’è¿½åŠ </h3>
            <div class="space-y-3">
                <button onclick="InputApp.confirmSource('camera')" class="w-full py-4 bg-gray-50 dark:bg-gray-700 rounded-xl flex items-center justify-center gap-3 font-bold text-gray-800 dark:text-white"><i class="ph-bold ph-camera text-xl text-corporate-500"></i> ã‚«ãƒ¡ãƒ©</button>
                <button onclick="InputApp.confirmSource('gallery')" class="w-full py-4 bg-gray-50 dark:bg-gray-700 rounded-xl flex items-center justify-center gap-3 font-bold text-gray-800 dark:text-white"><i class="ph-bold ph-image text-xl text-purple-500"></i> ã‚®ãƒ£ãƒ©ãƒªãƒ¼</button>
                <button onclick="InputApp.closeSourceSelect()" class="w-full py-4 mt-2 text-gray-400 font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="qr-overlay" class="fixed inset-0 z-[9999] bg-black hidden flex-col">
        <div class="absolute top-0 left-0 w-full p-6 flex justify-end z-10">
            <button onclick="InputApp.stopQRScanner()" class="w-10 h-10 bg-black/50 text-white rounded-full flex items-center justify-center backdrop-blur-md"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <div class="flex-1 relative flex items-center justify-center overflow-hidden">
            <video id="qr-video" class="absolute inset-0 w-full h-full object-cover"></video>
            <div class="w-64 h-64 border-2 border-corporate-500 rounded-3xl relative z-10 flex items-center justify-center">
                <div class="w-full h-0.5 bg-corporate-500/50 absolute top-1/2 animate-pulse"></div>
            </div>
            <div class="absolute bottom-20 text-white text-sm font-bold bg-black/50 px-4 py-2 rounded-full backdrop-blur">QRã‚³ãƒ¼ãƒ‰ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„</div>
        </div>
        <canvas id="qr-canvas" class="hidden"></canvas>
    </div>

    <div id="drawingOverlay" class="fixed inset-0 bg-gray-900 z-[6000] hidden flex-col">
        <div class="flex justify-between items-center px-4 py-3 bg-gray-900 text-white shrink-0 border-b border-gray-800">
            <button onclick="InputApp.closeDrawing()" class="text-gray-400 font-bold text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <span class="font-bold">å†™çœŸç·¨é›†</span>
            <button onclick="InputApp.saveDrawing()" class="text-corporate-400 font-bold text-sm">ä¿å­˜</button>
        </div>
        <div class="flex-1 relative bg-black flex items-center justify-center overflow-hidden touch-none" id="canvas-container">
            <canvas id="drawCanvas" class="max-w-full max-h-full object-contain"></canvas>
        </div>
        <div class="px-4 py-4 bg-gray-900 text-white shrink-0 flex flex-col gap-4 pb-safe">
            <div class="flex justify-center gap-4 border-b border-gray-800 pb-4">
                <button onclick="InputApp.setTool('pen')" id="tool-pen" class="tool-btn w-10 h-10 rounded-xl bg-gray-700 text-white flex items-center justify-center ring-2 ring-corporate-500"><i class="ph-bold ph-pencil-simple text-xl"></i></button>
                <button onclick="InputApp.setTool('rect')" id="tool-rect" class="tool-btn w-10 h-10 rounded-xl bg-gray-800 text-gray-400 flex items-center justify-center"><i class="ph-bold ph-square text-xl"></i></button>
                <button onclick="InputApp.setTool('circle')" id="tool-circle" class="tool-btn w-10 h-10 rounded-xl bg-gray-800 text-gray-400 flex items-center justify-center"><i class="ph-bold ph-circle text-xl"></i></button>
            </div>
            <div class="flex justify-center gap-6 items-center">
                <button onclick="InputApp.setPenColor('red')" id="color-red" class="w-8 h-8 rounded-full bg-red-500 border-2 border-white ring-2 ring-red-500/50 transition-transform active:scale-90"></button>
                <button onclick="InputApp.setPenColor('yellow')" id="color-yellow" class="w-8 h-8 rounded-full bg-yellow-400 border-2 border-transparent opacity-50 transition-transform active:scale-90"></button>
                <div class="w-px h-8 bg-gray-700 mx-2"></div>
                <button onclick="InputApp.undoDrawing()" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 active:bg-gray-700"><i class="ph-bold ph-arrow-u-up-left text-lg"></i></button>
                <button onclick="InputApp.clearCanvas()" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700 active:bg-gray-700"><i class="ph-bold ph-trash text-lg"></i></button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 z-[10000] hidden flex items-center justify-center bg-gray-900/50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-gray-800 w-[90%] max-w-sm rounded-2xl p-6 shadow-xl transform scale-95 transition-all">
            <div class="flex flex-col items-center text-center">
                <div class="w-12 h-12 rounded-full bg-red-50 dark:bg-red-900/30 text-red-500 flex items-center justify-center mb-4"><i class="ph-fill ph-trash text-2xl"></i></div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                <div class="flex gap-3 w-full">
                    <button onclick="InputApp.closeDeleteModal()" class="flex-1 py-2.5 rounded-lg font-medium text-gray-600 bg-gray-100 dark:bg-gray-700 dark:text-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="InputApp.confirmDelete()" class="flex-1 py-2.5 rounded-lg font-medium text-white bg-red-500 hover:bg-red-600">å‰Šé™¤ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 z-[11000] hidden flex items-center justify-center bg-gray-900/50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-gray-800 w-[85%] max-w-[320px] rounded-2xl p-6 shadow-xl transform scale-95 transition-all relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-red-500"></div>
            <div class="flex flex-col items-center text-center mb-5 mt-2">
                <div class="text-red-500 mb-2"><i class="ph-fill ph-warning-octagon text-4xl"></i></div>
                <h3 class="text-base font-bold text-gray-900 dark:text-white">å…¥åŠ›ã‚¨ãƒ©ãƒ¼</h3>
                <p class="text-xs text-gray-500 mt-1">å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-3 mb-5 border border-gray-100 dark:border-gray-700">
                <ul id="custom-alert-list" class="space-y-1 text-xs"></ul>
            </div>
            <button onclick="InputApp.closeCustomAlert()" class="w-full py-2.5 rounded-lg font-bold text-white bg-gray-800 hover:bg-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600">ç¢ºèªã—ã¦ä¿®æ­£</button>
        </div>
    </div>


    <script>
        // ğŸš€ 1. í¬íŠ¸í´ë¦¬ì˜¤ìš© ê°€ì§œ ë°ì´í„° (50ê°œ ì›ë³¸ ë°ì´í„° ì¼ë¶€ + í™•ì¥ ê°€ëŠ¥)
        let MOCK_DATA = [
            { id: '1', date: '2026-01-08', location: 'å·¥å…·æ£š A-01', name: 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼', email: 'staff1@example.com', dept: 'è£½é€ éƒ¨', qty: 3, photo1: 'https://placehold.co/300/0ea5e9/white?text=Tool', photo2: '', photo3: '' },
            { id: '2', date: '2026-01-08', location: 'å‚™å“ãƒ­ãƒƒã‚«ãƒ¼ B', name: 'å®‰å…¨é´ (26.5cm)', email: 'staff2@example.com', dept: 'è³‡æèª²', qty: 12, photo1: '', photo2: '', photo3: '' },
            { id: '3', date: '2026-01-07', location: 'æ¶ˆè€—å“æ£š C-3', name: 'é˜²å¡µãƒã‚¹ã‚¯ (N95)', email: 'staff3@example.com', dept: 'å®‰å…¨ç®¡ç†', qty: 45, photo1: '', photo2: '', photo3: '' },
            { id: '4', date: '2026-01-07', location: 'äº‹å‹™å®¤æ£š', name: 'A4ã‚³ãƒ”ãƒ¼ç”¨ç´™', email: 'admin@example.com', dept: 'ç·å‹™éƒ¨', qty: 8, photo1: '', photo2: '', photo3: '' },
            { id: '5', date: '2026-01-06', location: 'å…¥ã‚Šå£å€‰åº«', name: 'ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¶ˆæ¯’æ¶²', email: 'admin@example.com', dept: 'ç·å‹™éƒ¨', qty: 2, photo1: '', photo2: '', photo3: '' },
            { id: '6', date: '2026-01-06', location: 'æ¶ˆè€—å“æ£š C-1', name: 'è»æ‰‹ (æ»‘ã‚Šæ­¢ã‚ä»˜)', email: 'staff1@example.com', dept: 'è£½é€ éƒ¨', qty: 120, photo1: '', photo2: '', photo3: '' },
            { id: '7', date: '2026-01-05', location: 'å·¥å…·æ£š A-02', name: 'å…­è§’ãƒ¬ãƒ³ãƒã‚»ãƒƒãƒˆ', email: 'staff1@example.com', dept: 'è£½é€ éƒ¨', qty: 5, photo1: '', photo2: '', photo3: '' },
            { id: '8', date: '2026-01-05', location: 'å‡ºè·ã‚¨ãƒªã‚¢', name: 'æ¢±åŒ…ç”¨ãƒ†ãƒ¼ãƒ—', email: 'staff4@example.com', dept: 'ç‰©æµèª²', qty: 30, photo1: '', photo2: '', photo3: '' },
            { id: '9', date: '2026-01-04', location: 'å‚™å“ãƒ­ãƒƒã‚«ãƒ¼ A', name: 'ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ (ç™½)', email: 'staff3@example.com', dept: 'å®‰å…¨ç®¡ç†', qty: 15, photo1: '', photo2: '', photo3: '' },
            { id: '10', date: '2026-01-04', location: 'ã‚µãƒ¼ãƒãƒ¼å®¤', name: 'ä½œæ¥­ç”¨ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ', email: 'it_admin@example.com', dept: 'ITæ¨é€²å®¤', qty: 4, photo1: '', photo2: '', photo3: '' }
        ];
        let MOCK_MASTER = [
            { name: 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼', email: 'staff1@example.com', dept: 'è£½é€ éƒ¨' },
            { name: 'å®‰å…¨é´ (26.5cm)', email: 'staff2@example.com', dept: 'è³‡æèª²' },
            { name: 'é˜²å¡µãƒã‚¹ã‚¯ (N95)', email: 'staff3@example.com', dept: 'å®‰å…¨ç®¡ç†' }
        ];

        // ğŸ¨ 2. í…Œë§ˆ & ì• ë‹ˆë©”ì´ì…˜ ì œì–´
        window.ThemeManager = {
            init: function() {
                const isDark = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) document.documentElement.classList.add('dark');
                this.updateIcon();
            },
            toggle: function() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                this.updateIcon();
                if(typeof DashboardApp !== 'undefined' && DashboardApp.renderCharts) DashboardApp.renderCharts();
            },
            updateIcon: function() {
                const isDark = document.documentElement.classList.contains('dark');
                document.querySelectorAll('#themeIcon, #themeIconMobile').forEach(i => i.className = isDark ? 'ph-bold ph-sun text-lg' : 'ph-bold ph-moon-stars text-lg');
            }
        };
        window.ThemeManager.init();

        const IntroAnim = (() => {
            let frameId, canvas, ctx, w, h, particles = [];
            function init() {
                canvas = document.getElementById('intro-canvas'); if (!canvas) return;
                ctx = canvas.getContext('2d');
                const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
                window.addEventListener('resize', resize); resize();
                for (let i = 0; i < 40; i++) particles.push({ x: Math.random()*w, y: Math.random()*h, vx: (Math.random()-0.5), vy: (Math.random()-0.5), size: Math.random()*2+1 });
                animate();
            }
            function animate() {
                const screen = document.getElementById('intro-screen');
                if (!screen || screen.classList.contains('fade-out')) { cancelAnimationFrame(frameId); return; }
                ctx.clearRect(0, 0, w, h);
                const isDark = document.documentElement.classList.contains('dark');
                ctx.fillStyle = isDark ? 'rgba(255,255,255,0.4)' : 'rgba(14,165,233,0.4)';
                ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(14,165,233,0.08)';
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; if (p.x < 0 || p.x > w) p.vx *= -1; if (p.y < 0 || p.y > h) p.vy *= -1;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                for(let i=0; i<particles.length; i++){
                    for(let j=i+1; j<particles.length; j++){
                        const dist = Math.hypot(particles[i].x - particles[j].x, particles[i].y - particles[j].y);
                        if(dist < 120) { ctx.beginPath(); ctx.moveTo(particles[i].x, particles[i].y); ctx.lineTo(particles[j].x, particles[j].y); ctx.stroke(); }
                    }
                }
                frameId = requestAnimationFrame(animate);
            }
            return { start: init, stop: () => { const el = document.getElementById('intro-screen'); if(el) el.classList.add('fade-out'); } };
        })();
        document.addEventListener('DOMContentLoaded', IntroAnim.start);

        // ğŸ”€ 3. ë¼ìš°í„° (í˜ì´ì§€ ì „í™˜)
        const AppRouter = (() => {
            function init() { switchRoute('dashboard'); }
            function switchRoute(route) {
                const spinner = document.getElementById('loadingSpinner'); if (spinner) spinner.classList.remove('hidden');
                
                setTimeout(() => {
                    ['view-dashboard', 'view-input'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
                    document.querySelectorAll('.nav-link, .mobile-tab').forEach(el => el.classList.remove('active'));
                    
                    const deskNav = document.getElementById('nav-' + route); if(deskNav) deskNav.classList.add('active');
                    const mobNav = document.getElementById('mobile-nav-' + route); if(mobNav) mobNav.classList.add('active');
                    
                    const view = document.getElementById('view-' + route);
                    if(view) {
                        view.classList.remove('hidden');
                        if(route === 'dashboard' && DashboardApp.init) DashboardApp.init();
                        if(route === 'input' && InputApp.init) InputApp.init();
                    }
                    window.scrollTo(0,0);
                    if (spinner) spinner.classList.add('hidden');
                }, 100); // ê°€ì§œ ë”œë ˆì´
            }
            return { init, switch: switchRoute };
        })();

        // ğŸ“Š 4. ëŒ€ì‹œë³´ë“œ (ì°¨íŠ¸ ë° ìš”ì•½)
        const DashboardApp = (() => {
            let deptChart, trendChart;
            function init() { fetchData(); }
            function fetchData() {
                const spinner = document.getElementById('loadingSpinner'); if(spinner) spinner.classList.remove('hidden');
                setTimeout(() => {
                    if (document.getElementById('intro-screen')) IntroAnim.stop();
                    renderKPIs(); renderWarning(); renderList(); renderCharts();
                    populateMonthFilter();
                    if(spinner) spinner.classList.add('hidden');
                }, 300);
            }
            function populateMonthFilter() {
                const el = document.getElementById('monthFilter');
                if(el.options.length === 0) el.innerHTML = '<option value="2026-01">2026/01</option><option value="2025-12">2025/12</option>';
            }
            function renderKPIs() {
                const total = MOCK_DATA.reduce((sum, item) => sum + parseInt(item.qty||0), 0);
                const locs = new Set(MOCK_DATA.map(i => i.location)).size;
                const depts = new Set(MOCK_DATA.map(i => i.dept)).size;
                const kpis = [
                    { label: 'ç·åœ¨åº«æ•°', val: total, unit: 'å€‹', icon: 'ph-stack', color: 'text-corporate-600', bg: 'bg-corporate-50' },
                    { label: 'å‰æœˆæ¯”', val: '+15', unit: '%', icon: 'ph-trend-up', color: 'text-emerald-500', bg: 'bg-emerald-50' },
                    { label: 'ä¿ç®¡å ´æ‰€', val: locs, unit: 'ç®‡æ‰€', icon: 'ph-map-pin', color: 'text-orange-500', bg: 'bg-orange-50' },
                    { label: 'ç®¡ç†éƒ¨ç½²', val: depts, unit: 'éƒ¨ç½²', icon: 'ph-buildings', color: 'text-purple-500', bg: 'bg-purple-50' }
                ];
                document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
                    <div class="card p-4 relative overflow-hidden group">
                        <div class="absolute -right-2 -bottom-2 opacity-10 text-5xl group-hover:scale-110 transition-transform"><i class="ph-fill ${k.icon} ${k.color}"></i></div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">${k.label}</p>
                        <div class="flex items-baseline gap-1 relative z-10">
                            <p class="text-2xl font-bold text-gray-800 dark:text-white leading-none">${k.val}</p>
                            <span class="text-xs font-medium text-gray-500">${k.unit}</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('summaryList').innerHTML = `
                    <li><span class="font-bold text-gray-800 dark:text-white">ç·æ•° ${total}å€‹</span>ã€‚å‰æœˆæ¯”å¢—åŠ ã€‚</li>
                    <li><span class="font-bold text-gray-800 dark:text-white">è£½é€ éƒ¨</span>ãŒæœ€å¤šç®¡ç†ã€‚</li>
                `;
            }
            function renderWarning() {
                const threshold = parseInt(document.getElementById('warningThreshold').value) || 20;
                const warnings = MOCK_DATA.filter(i => parseInt(i.qty) >= threshold).sort((a,b)=> b.qty - a.qty);
                const container = document.getElementById('warningContainer');
                if(warnings.length === 0) { container.style.display = 'none'; return; }
                container.style.display = 'block';
                document.getElementById('warningTableBody').innerHTML = warnings.map(i => `
                    <tr>
                        <td class="py-2 px-1 font-medium text-gray-800 dark:text-gray-200 truncate max-w-[120px]">${i.name}</td>
                        <td class="py-2 px-1 text-right font-bold text-red-500">${i.qty}</td>
                    </tr>
                `).join('');
            }
            function renderList() {
                const container = document.getElementById('dataCardsContainer');
                const grouped = MOCK_DATA.reduce((acc, item) => { acc[item.location] = acc[item.location] || []; acc[item.location].push(item); return acc; }, {});
                container.innerHTML = Object.keys(grouped).sort().map(loc => {
                    const items = grouped[loc]; const qty = items.reduce((s, i) => s + parseInt(i.qty), 0);
                    return `
                        <div onclick="DashboardApp.openLocationDetail('${loc}')" class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:border-corporate-500 bg-white dark:bg-gray-800 transition-all flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-corporate-50 dark:bg-corporate-900/30 flex items-center justify-center text-corporate-500 shrink-0"><i class="ph-fill ph-map-pin text-xl"></i></div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-sm text-gray-900 dark:text-white truncate">${loc}</h3>
                                <p class="text-[10px] text-gray-500">${items.length} ç¨®é¡</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-sm font-black text-gray-800 dark:text-white leading-none">${qty}</span>
                                <span class="text-[9px] text-gray-400">å€‹</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            function renderCharts() {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#9ca3af' : '#6b7280'; const gridColor = isDark ? '#374151' : '#f3f4f6';
                Chart.defaults.color = textColor; Chart.defaults.font.family = "'Inter', sans-serif";
                const deptData = MOCK_DATA.reduce((acc, i) => { acc[i.dept] = (acc[i.dept]||0) + parseInt(i.qty); return acc; }, {});
                
                if(deptChart) deptChart.destroy();
                deptChart = new Chart(document.getElementById('departmentChart'), {
                    type: 'bar',
                    data: { labels: Object.keys(deptData), datasets: [{ data: Object.values(deptData), backgroundColor: '#0ea5e9', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, datalabels: { anchor:'end', align:'top', font:{weight:'bold'} } }, scales: { x: { grid: {display: false} }, y: { beginAtZero: true, grace: '10%', grid: {color: gridColor}, border: {display: false} } } }
                });
                if(trendChart) trendChart.destroy();
                trendChart = new Chart(document.getElementById('comparisonChart'), {
                    type: 'line',
                    data: { labels: ['10æœˆ','11æœˆ','12æœˆ','1æœˆ'], datasets: [{ data: [110, 150, 180, 240], borderColor: '#0369a1', backgroundColor: 'rgba(3,105,161,0.1)', fill: true, tension: 0.4, borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, datalabels: {display: false} }, scales: { x: { grid: {display: false} }, y: { beginAtZero: true, grid: {color: gridColor}, border: {display: false} } } }
                });
            }
            function openLocationDetail(loc) {
                const items = MOCK_DATA.filter(i => i.location === loc).sort((a,b)=> b.qty - a.qty);
                document.getElementById('dash-panel-title').innerText = loc;
                document.getElementById('dash-panel-content').innerHTML = items.map(i => {
                    const hasPhoto = i.photo1 || i.photo2 || i.photo3;
                    let photoIcon = `<div class="w-10 h-10 rounded-md bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400"><i class="ph-duotone ph-cube text-lg"></i></div>`;
                    if (hasPhoto && i.photo1) photoIcon = `<img src="${i.photo1}" class="w-10 h-10 rounded-md object-cover border border-gray-200 dark:border-gray-600">`;
                    return `<div class="card p-3 flex items-center gap-3 ${hasPhoto?'cursor-pointer hover:border-corporate-400':''}" ${hasPhoto?`onclick="InputApp.openGallery('${i.id}')"`:''}>
                        ${photoIcon}
                        <div class="flex-1 min-w-0"><div class="text-sm font-bold text-gray-800 dark:text-white truncate">${i.name}</div><div class="text-[10px] text-gray-500">${i.dept}</div></div>
                        <div class="text-right"><span class="text-base font-black text-gray-800 dark:text-white">${i.qty}</span><span class="text-[9px] text-gray-400 ml-0.5">å€‹</span></div>
                    </div>`;
                }).join('');
                document.getElementById('form-overlay').classList.add('open'); document.getElementById('dashboard-panel').classList.add('open');
            }
            function closeLocationDetail() { document.getElementById('form-overlay').classList.remove('open'); document.getElementById('dashboard-panel').classList.remove('open'); }
            return { init, fetchData, renderWarning, renderCharts, openLocationDetail, closeLocationDetail };
        })();

        // ğŸ“ 5. ì…ë ¥ & ê´€ë¦¬ (ì˜¤ë¦¬ì§€ë„ ê·¸ë£¹í•‘ ë¦¬ìŠ¤íŠ¸, Draw, QR í¬í•¨)
        const InputApp = (() => {
            let editedFiles = { file1: null, file2: null, file3: null };
            let currentTargetFileId = null, pendingDeleteId = null, videoStream = null, isScanning = false;
            let currentDrawingFileId = null, canvas, ctx, isDrawing = false, drawingImg = new Image(), currentTool = 'pen', startX, startY, snapshot, history = [];
            
            function init() { renderGroupedList(); }

            // ë‚ ì§œ/ì¥ì†Œë³„ ê·¸ë£¹í•‘ ë¦¬ìŠ¤íŠ¸ ì™„ë²½ ë³µì› + B2B UI ì ìš©
            function renderGroupedList(query = '') {
                const container = document.getElementById('input-list-container');
                let data = [...MOCK_DATA].sort((a, b) => new Date(b.date) - new Date(a.date));
                if(query) {
                    const lower = query.toLowerCase();
                    data = data.filter(i => i.name.toLowerCase().includes(lower) || i.location.toLowerCase().includes(lower));
                }
                
                if(data.length === 0) { container.innerHTML = `<div class="p-10 text-center text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`; return; }

                const groupedByDate = data.reduce((acc, item) => { const d = item.date || 'æ—¥ä»˜ãªã—'; acc[d] = acc[d] || []; acc[d].push(item); return acc; }, {});
                
                let html = '';
                Object.keys(groupedByDate).sort().reverse().forEach(date => {
                    const dateItems = groupedByDate[date];
                    const groupedByLoc = dateItems.reduce((acc, item) => { const l = item.location || 'å ´æ‰€æœªå®š'; acc[l] = acc[l] || []; acc[l].push(item); return acc; }, {});
                    
                    let locHtml = '';
                    Object.keys(groupedByLoc).sort().forEach(loc => {
                        const locItems = groupedByLoc[loc].sort((a,b) => b.qty - a.qty);
                        const itemsHtml = locItems.map(item => `
                            <div class="flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm hover:border-corporate-400 transition-colors group">
                                <div class="w-12 h-10 bg-gray-50 dark:bg-gray-700 rounded flex flex-col items-center justify-center shrink-0 border border-gray-100 dark:border-gray-600">
                                    <span class="text-sm font-black text-corporate-600 dark:text-corporate-400 leading-none">${item.qty}</span>
                                    <span class="text-[8px] text-gray-400 font-bold mt-0.5">æ•°é‡</span>
                                </div>
                                <div class="flex-1 min-w-0 cursor-pointer" onclick="InputApp.openPanel('detail', '${item.id}')">
                                    <div class="text-sm font-bold text-gray-900 dark:text-white truncate">${item.name}</div>
                                    <div class="text-[10px] text-gray-500 truncate mt-0.5">${item.dept}</div>
                                </div>
                                <div class="flex items-center gap-1 shrink-0 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                    <button onclick="InputApp.openPanel('edit', '${item.id}')" class="w-8 h-8 flex items-center justify-center rounded text-gray-400 hover:text-corporate-600 hover:bg-corporate-50"><i class="ph-bold ph-pencil-simple text-base"></i></button>
                                    <button onclick="InputApp.requestDelete('${item.id}')" class="w-8 h-8 flex items-center justify-center rounded text-gray-400 hover:text-red-500 hover:bg-red-50"><i class="ph-bold ph-trash text-base"></i></button>
                                </div>
                            </div>
                        `).join('');

                        locHtml += `
                            <details open class="group/loc ml-2 mt-2">
                                <summary class="flex items-center gap-2 cursor-pointer list-none mb-2 text-sm text-gray-600 dark:text-gray-300 font-medium">
                                    <i class="ph-fill ph-map-pin text-corporate-500"></i> ${loc} 
                                    <span class="bg-gray-100 dark:bg-gray-700 text-[10px] px-1.5 py-0.5 rounded-full font-bold">${locItems.length}</span>
                                    <i class="ph-bold ph-caret-down text-xs text-gray-400 transition-transform group-open/loc:rotate-180 ml-auto mr-2"></i>
                                </summary>
                                <div class="space-y-2 pl-2 border-l-2 border-gray-100 dark:border-gray-700 ml-1.5 mb-4">${itemsHtml}</div>
                            </details>
                        `;
                    });

                    html += `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-4">
                            <div class="px-4 py-3 bg-gray-50/80 dark:bg-gray-800/80 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 class="font-bold text-sm text-gray-800 dark:text-white"><i class="ph-bold ph-calendar-blank mr-1 text-gray-400"></i> ${date}</h3>
                                <span class="bg-white dark:bg-gray-700 px-2 py-0.5 rounded text-xs font-bold text-gray-500 shadow-sm border border-gray-200 dark:border-gray-600">${dateItems.length}ä»¶</span>
                            </div>
                            <div class="p-2">${locHtml}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            function filterList(q) { renderGroupedList(q); }

            // Panel / Form Control
            function openPanel(mode, id) {
                const form = document.getElementById('dataForm'), detail = document.getElementById('detail-view'), footer = document.getElementById('form-footer'), btnEdit = document.getElementById('btn-edit-mode'), title = document.getElementById('panel-title');
                form.reset(); document.getElementById('form-id').value = "";
                ['preview1', 'preview2', 'preview3'].forEach(pid => { const p = document.getElementById(pid); if(p) { p.src=''; p.classList.add('hidden'); } });
                ['btn-draw-file1', 'btn-draw-file2', 'btn-draw-file3'].forEach(bid => { const b = document.getElementById(bid); if(b) b.classList.add('hidden'); });
                editedFiles = { file1: null, file2: null, file3: null };

                if(mode === 'create') {
                    title.innerText = 'æ–°è¦ç™»éŒ²';
                    form.classList.remove('hidden'); footer.classList.remove('hidden');
                    detail.classList.add('hidden'); btnEdit.classList.add('hidden');
                    document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
                } else if(mode === 'edit') {
                    title.innerText = 'å†…å®¹ã®ç·¨é›†';
                    form.classList.remove('hidden'); footer.classList.remove('hidden');
                    detail.classList.add('hidden'); btnEdit.classList.add('hidden');
                    const item = MOCK_DATA.find(i => i.id === id); if(item) fillForm(item);
                } else {
                    title.innerText = 'è©³ç´°æƒ…å ±';
                    form.classList.add('hidden'); footer.classList.add('hidden');
                    detail.classList.remove('hidden'); btnEdit.classList.remove('hidden');
                    const item = MOCK_DATA.find(i => i.id === id);
                    if(item) {
                        fillForm(item); // For edit transition
                        document.getElementById('view-date').innerText = item.date;
                        document.getElementById('view-name').innerText = item.name;
                        document.getElementById('view-dept').innerText = item.dept || '-';
                        document.getElementById('view-location').innerText = item.location || '-';
                        document.getElementById('view-qty').innerText = item.qty;
                        const photos = [item.photo1, item.photo2, item.photo3].filter(Boolean);
                        document.getElementById('detail-photos').innerHTML = photos.length > 0 ? photos.map(p => `<img src="${p}" onclick="InputApp.openGallery('${item.id}')" class="w-full h-32 object-cover rounded-lg border border-gray-200 cursor-pointer shadow-sm">`).join('') : '<div class="col-span-2 text-center text-xs text-gray-400 py-6 border border-dashed rounded-lg border-gray-300">å†™çœŸãªã—</div>';
                    }
                }
                document.getElementById('form-overlay').classList.add('open');
                
                // ëª¨ë°”ì¼ì—ì„œ íŒ¨ë„ì´ ìŠ¬ë¼ì´ë“œë  ë•Œ í‚¤ë³´ë“œ ë‚´ë¦¬ê¸°
                if(document.activeElement) document.activeElement.blur();
                
                // íŒ¨ë„ ì—´ë¦´ ë•Œ ì•ˆìª½ DOM ìš”ì†Œë“¤ì´ ë¨¼ì € ë°°ì¹˜ë˜ê²Œ delay
                const panel = document.getElementById('form-panel');
                panel.style.display = 'flex';
                setTimeout(() => panel.classList.add('open'), 10);
            }
            function closePanel() {
                document.getElementById('form-overlay').classList.remove('open');
                document.getElementById('form-panel').classList.remove('open');
            }
            function enableEditMode() {
                document.getElementById('panel-title').innerText = 'å†…å®¹ã®ç·¨é›†';
                document.getElementById('detail-view').classList.add('hidden'); document.getElementById('btn-edit-mode').classList.add('hidden');
                document.getElementById('dataForm').classList.remove('hidden'); document.getElementById('form-footer').classList.remove('hidden');
            }
            function fillForm(item) {
                document.getElementById('form-id').value = item.id; document.getElementById('form-date').value = item.date;
                document.getElementById('form-qty').value = item.qty; document.getElementById('form-name').value = item.name;
                document.getElementById('form-dept').value = item.dept; document.getElementById('form-location').value = item.location;
                if(item.photo1) { document.getElementById('preview1').src = item.photo1; document.getElementById('preview1').classList.remove('hidden'); document.getElementById('btn-draw-file1').classList.remove('hidden'); }
            }

            // Custom Alert (Validation)
            function showCustomAlert(missing) {
                const modal = document.getElementById('custom-alert-modal'), list = document.getElementById('custom-alert-list');
                list.innerHTML = missing.map(m => `<li class="flex items-center gap-2"><i class="ph-bold ph-x text-red-500"></i> ${m}</li>`).join('');
                modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.remove('scale-95'); modal.firstElementChild.classList.add('scale-100'); }, 10);
            }
            function closeCustomAlert() {
                const modal = document.getElementById('custom-alert-modal');
                modal.classList.add('opacity-0'); modal.firstElementChild.classList.remove('scale-100'); modal.firstElementChild.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            // Data Submission
            function submitData() {
                const required = [ {id:'form-date', label:'æ—¥ä»˜'}, {id:'form-name', label:'åå‰'}, {id:'form-location', label:'å ´æ‰€'}, {id:'form-qty', label:'æ•°é‡'} ];
                const missing = required.filter(f => !document.getElementById(f.id).value.trim()).map(f => f.label);
                if (missing.length > 0) { showCustomAlert(missing); return; }

                const spinner = document.getElementById('loadingSpinner'); spinner.classList.remove('hidden');

                setTimeout(() => { // Mock API Delay
                    const id = document.getElementById('form-id').value;
                    const newItem = {
                        id: id || 'MOCK_' + Date.now(),
                        date: document.getElementById('form-date').value,
                        name: document.getElementById('form-name').value,
                        dept: document.getElementById('form-dept').value || '-',
                        location: document.getElementById('form-location').value || '-',
                        qty: document.getElementById('form-qty').value,
                        photo1: editedFiles['file1'] || document.getElementById('preview1').src || '',
                        photo2: editedFiles['file2'] || document.getElementById('preview2').src || '',
                        photo3: editedFiles['file3'] || document.getElementById('preview3').src || ''
                    };

                    if(id) { const idx = MOCK_DATA.findIndex(i => i.id === id); if(idx > -1) MOCK_DATA[idx] = newItem; } 
                    else { MOCK_DATA.push(newItem); }

                    spinner.classList.add('hidden');
                    
                    if(document.getElementById('continuous-mode').checked && !id) {
                        document.getElementById('form-name').value = ''; document.getElementById('form-qty').value = '';
                        document.getElementById('form-name').focus();
                        ['preview1', 'preview2', 'preview3'].forEach(pid => { const p = document.getElementById(pid); if(p){p.src=''; p.classList.add('hidden');}});
                        ['btn-draw-file1', 'btn-draw-file2', 'btn-draw-file3'].forEach(bid => { const b = document.getElementById(bid); if(b) b.classList.add('hidden'); });
                        editedFiles = { file1: null, file2: null, file3: null };
                        let countEl = document.getElementById('session-counter-display'); countEl.innerText = `ä»Šå›: ${parseInt(countEl.innerText.replace(/[^0-9]/g, ''))+1}ä»¶`;
                    } else {
                        closePanel();
                    }
                    renderGroupedList();
                    if(typeof DashboardApp !== 'undefined' && DashboardApp.init) DashboardApp.init(); // Refresh Dashboard
                }, 300);
            }

            // Deletion
            function requestDelete(id) {
                pendingDeleteId = id; const modal = document.getElementById('delete-modal'); modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.firstElementChild.classList.remove('scale-95'); modal.firstElementChild.classList.add('scale-100'); }, 10);
            }
            function closeDeleteModal() {
                const modal = document.getElementById('delete-modal'); modal.classList.add('opacity-0'); modal.firstElementChild.classList.remove('scale-100'); modal.firstElementChild.classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); pendingDeleteId = null; }, 300);
            }
            function confirmDelete() {
                if(!pendingDeleteId) return;
                MOCK_DATA = MOCK_DATA.filter(i => i.id !== pendingDeleteId);
                closeDeleteModal(); renderGroupedList();
                if(typeof DashboardApp !== 'undefined' && DashboardApp.init) DashboardApp.init();
            }

            // Auto-complete Name
            function handleNameInput(input) {
                const val = input.value.toLowerCase().trim(); const listEl = document.getElementById('name-suggestions');
                if (val.length < 1) { listEl.classList.add('hidden'); return; }
                const matches = MOCK_MASTER.filter(p => p.name.toLowerCase().includes(val));
                if (matches.length === 0) { listEl.classList.add('hidden'); return; }
                listEl.innerHTML = matches.map(p => `<li class="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-0" onclick="InputApp.selectName('${p.name}', '${p.dept}')"><div class="font-bold text-gray-800 dark:text-white">${p.name}</div><div class="text-xs text-gray-500 mt-1">${p.dept}</div></li>`).join('');
                listEl.classList.remove('hidden');
            }
            function selectName(name, dept) {
                document.getElementById('form-name').value = name; document.getElementById('form-dept').value = dept;
                document.getElementById('name-suggestions').classList.add('hidden');
            }

            // Photos & Camera
            function openSourceSelect(fileId) { currentTargetFileId = fileId; const overlay = document.getElementById('sourceSelectOverlay'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); setTimeout(()=>{overlay.classList.remove('opacity-0'); document.getElementById('sourceSelectBox').classList.remove('translate-y-full');},10); }
            function closeSourceSelect() { const overlay = document.getElementById('sourceSelectOverlay'); overlay.classList.add('opacity-0'); document.getElementById('sourceSelectBox').classList.add('translate-y-full'); setTimeout(()=>{ overlay.classList.add('hidden'); overlay.classList.remove('flex'); },300); currentTargetFileId = null; }
            function confirmSource(type) { if (!currentTargetFileId) return; const input = document.getElementById(currentTargetFileId); if (type === 'camera') input.setAttribute('capture', 'environment'); else input.removeAttribute('capture'); closeSourceSelect(); setTimeout(() => input.click(), 100); }
            function handleFileSelect(input, imgId) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById(imgId).src = e.target.result; document.getElementById(imgId).classList.remove('hidden');
                        const btn = document.getElementById('btn-draw-' + input.id); if(btn) btn.classList.remove('hidden');
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            // Gallery
            function openGallery(id) {
                const item = MOCK_DATA.find(i => i.id === id); if(!item) return;
                const container = document.getElementById('galleryContainer'); container.innerHTML = "";
                document.getElementById('galleryTitle').innerText = `${item.location} - ${item.name}`;
                const photos = [item.photo1, item.photo2, item.photo3].filter(Boolean);
                document.getElementById('galleryOverlay').style.display = 'flex'; document.getElementById('galleryOverlay').classList.remove('hidden');
                photos.forEach((url) => {
                    const wrapper = document.createElement('div'); wrapper.className = "w-full bg-gray-900/50 rounded-2xl flex justify-center items-center min-h-[350px] relative shrink-0 snap-center";
                    const img = document.createElement('img'); img.className = "max-w-full max-h-[70vh] rounded-xl object-contain"; img.src = url; 
                    wrapper.appendChild(img); container.appendChild(wrapper);
                });
                if(photos.length === 0) container.innerHTML = "<div class='text-white mt-20 opacity-50'>å†™çœŸãªã—</div>";
            }
            function closeGallery(e) { if (e.target.id === 'galleryOverlay' || e.target.closest('button')) { document.getElementById('galleryOverlay').classList.add('hidden'); document.getElementById('galleryOverlay').classList.remove('flex'); } }

            // Canvas Drawing Editor (ì™„ë²½ ë³µì›)
            function openDrawing(fileId, event) {
                if(event) event.stopPropagation();
                const previewId = 'preview' + fileId.replace('file', ''); const previewImg = document.getElementById(previewId);
                if (!previewImg || !previewImg.src || previewImg.classList.contains('hidden')) return;
                currentDrawingFileId = fileId;
                
                const overlay = document.getElementById('drawingOverlay'); canvas = document.getElementById('drawCanvas'); ctx = canvas.getContext('2d');
                overlay.classList.remove('hidden'); overlay.classList.add('flex'); history = [];
                
                drawingImg.crossOrigin = "Anonymous";
                drawingImg.onload = () => {
                    // í™”ë©´ í¬ê¸°ì— ë§ê²Œ ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ ì¡°ì •
                    const container = document.getElementById('canvas-container');
                    const imgRatio = drawingImg.width / drawingImg.height;
                    let cw = container.clientWidth, ch = container.clientWidth / imgRatio;
                    if(ch > container.clientHeight) { ch = container.clientHeight; cw = container.clientHeight * imgRatio; }
                    canvas.width = cw; canvas.height = ch;
                    ctx.drawImage(drawingImg, 0, 0, cw, ch); 
                    setTool('pen'); setPenColor('red'); 
                };
                drawingImg.src = previewImg.src;
                
                canvas.onmousedown = canvas.ontouchstart = startDraw;
                canvas.onmousemove = canvas.ontouchmove = draw;
                canvas.onmouseup = canvas.ontouchend = stopDraw;
            }
            function closeDrawing() { document.getElementById('drawingOverlay').classList.add('hidden'); document.getElementById('drawingOverlay').classList.remove('flex'); currentDrawingFileId = null; }
            function startDraw(e) { isDrawing = true; history.push(ctx.getImageData(0, 0, canvas.width, canvas.height)); ctx.beginPath(); const pos = getPos(e); startX = pos.x; startY = pos.y; if (currentTool === 'pen') ctx.moveTo(startX, startY); else snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height); }
            function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(e); if (currentTool === 'pen') { ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineTo(pos.x, pos.y); ctx.stroke(); } else { ctx.putImageData(snapshot, 0, 0); ctx.lineWidth = 4; ctx.beginPath(); if (currentTool === 'rect') { ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY); } else if (currentTool === 'circle') { const cx = startX + (pos.x - startX)/2, cy = startY + (pos.y - startY)/2, rx = Math.abs(pos.x - startX)/2, ry = Math.abs(pos.y - startY)/2; ctx.ellipse(cx, cy, rx, ry, 0, 0, 2*Math.PI); ctx.stroke(); } } }
            function stopDraw() { isDrawing = false; }
            function undoDrawing() { if (history.length > 0) ctx.putImageData(history.pop(), 0, 0); }
            function clearCanvas() { history.push(ctx.getImageData(0, 0, canvas.width, canvas.height)); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(drawingImg, 0, 0, canvas.width, canvas.height); }
            function getPos(e) { const r = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) }; }
            function setTool(tool) { currentTool = tool; ['tool-pen', 'tool-rect', 'tool-circle'].forEach(id => { const b = document.getElementById(id); b.classList.remove('bg-gray-700', 'text-white', 'ring-2', 'ring-corporate-500'); b.classList.add('bg-gray-800', 'text-gray-400'); }); const active = document.getElementById('tool-' + tool); active.classList.remove('bg-gray-800', 'text-gray-400'); active.classList.add('bg-gray-700', 'text-white', 'ring-2', 'ring-corporate-500'); }
            function setPenColor(color) { const r = document.getElementById('color-red'), y = document.getElementById('color-yellow'); r.classList.remove('ring-2', 'opacity-50'); y.classList.remove('ring-2', 'opacity-50'); if(color === 'red') { ctx.strokeStyle = '#EF4444'; r.classList.add('ring-2'); y.classList.add('opacity-50'); } else { ctx.strokeStyle = '#FACC15'; y.classList.add('ring-2'); r.classList.add('opacity-50'); } }
            function saveDrawing() { if (!currentDrawingFileId) return; try{ const dataUrl = canvas.toDataURL('image/jpeg', 0.8); document.getElementById('preview' + currentDrawingFileId.replace('file', '')).src = dataUrl; editedFiles[currentDrawingFileId] = dataUrl; }catch(e){ alert("CORSåˆ¶ç´„ã«ã‚ˆã‚Šä¿å­˜ã§ãã¾ã›ã‚“ã€‚"); } closeDrawing(); }

            // QR Scanner
            function startQRScanner() {
                const overlay = document.getElementById('qr-overlay'), video = document.getElementById('qr-video');
                if (!overlay || !video) return; overlay.classList.remove('hidden'); overlay.classList.add('flex'); isScanning = true;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => { videoStream = stream; video.srcObject = stream; video.setAttribute("playsinline", true); video.play(); requestAnimationFrame(scanTick); }).catch(err => { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err); stopQRScanner(); });
            }
            function scanTick() {
                if (!isScanning) return; const video = document.getElementById('qr-video'), canvas = document.getElementById('qr-canvas');
                if (!video || !canvas) return; const context = canvas.getContext('2d');
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth; context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    if(typeof jsQR !== 'undefined') {
                        const code = jsQR(context.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });
                        if (code) { document.getElementById('form-location').value = code.data; stopQRScanner(); return; }
                    }
                }
                requestAnimationFrame(scanTick);
            }
            function stopQRScanner() { isScanning = false; document.getElementById('qr-overlay').classList.add('hidden'); document.getElementById('qr-overlay').classList.remove('flex'); if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; } }

            return { init, filterList, openPanel, closePanel, enableEditMode, submitData, requestDelete, closeDeleteModal, confirmDelete, handleNameInput, selectName, openSourceSelect, closeSourceSelect, confirmSource, handleFileSelect, openGallery, closeGallery, openDrawing, closeDrawing, setTool, setPenColor, undoDrawing, clearCanvas, saveDrawing, startQRScanner, stopQRScanner, closeCustomAlert };
        })();

        document.addEventListener('DOMContentLoaded', () => { AppRouter.init(); });
    </script>
</body>
</html>
